<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>How to use Rails the Active Record Relation method #delete_all</title>

        <meta name="description" content="A quick overview of a Ruby on Rails ActiveRecord::Relation method &#39;#delete_all&#39;. A fast way to purge your Date Base of rows from a Table.">
        <meta itemprop="name" content="How to use Rails the Active Record Relation method #delete_all">
        <meta itemprop="description" content="A quick overview of a Ruby on Rails ActiveRecord::Relation method &#39;#delete_all&#39;. A fast way to purge your Date Base of rows from a Table.">

        
          <meta itemprop="datePublished"
                content="May 23, 2018">
          <meta itemprop="dateModified"
                content="May 23, 2018">
          <meta itemprop="image"  content="https://chrislabarge.com/img/trash.jpg" />
          <meta name="twitter:card" content="summary" />
          <meta name="twitter:site" content="@clabvessels" />
          <meta name="twitter:creator" content="@clabvessels" />
          <meta property="og:url" content="https://chrislabarge.com/posts/delete-all/" />
          <meta property="og:title" content="How to use Rails the Active Record Relation method #delete_all" />
          <meta property="og:type" content="article" />
          <meta property="og:description" content="A quick overview of a Ruby on Rails ActiveRecord::Relation method &#39;#delete_all&#39;. A fast way to purge your Date Base of rows from a Table." />
          <meta property="og:image" content="https://chrislabarge.com/img/trash.jpg" />
          <meta property="article:published_time" content="2018-05-23 18:30:21 -0500 -0500">
          <meta property="article:modified_time" content="2023-04-17T13:00:21-05:00">
        

        <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
        <link rel="stylesheet" href="/css/stylesheet.css">
        <link rel="stylesheet" href="/css/custom.css">
        <link rel="icon" type="image/png" href="/img/favicon.ico">

        <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
        <script src="/javascript/custom.js"></script>

        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-104350449-2"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-104350449-2');
        </script>
    </head>
    <body>
        <section id="pageHeader">
            
              <h2><a href="/">Chris LaBarge</a></h2>
            
        </section>
        <div class="content">








<nav class="taxonomy">
  <ul class="taxonomy-options">
    
      
      <li>
        <a data-list-class="categories"
           class="clickable active">
          categories
        </a>
      </li>
    
      
      <li>
        <a data-list-class="tags"
           class="clickable ">
          tags
        </a>
      </li>
    
  </ul>

  
    

    
      
    

    <ul class ="taxonomy-list categories active">
      
        <li>
          <a href="https://chrislabarge.com/categories/tutorial/"
             class="">
             tutorial
            <span class="float-right">4</span>
          </a>
        </li>
      
        <li>
          <a href="https://chrislabarge.com/categories/dev-tools/"
             class="active">
             dev-tools
            <span class="float-right">3</span>
          </a>
        </li>
      
        <li>
          <a href="https://chrislabarge.com/categories/review/"
             class="">
             review
            <span class="float-right">2</span>
          </a>
        </li>
      
    </ul>
  
    

    
      
    

    <ul class ="taxonomy-list tags ">
      
        <li>
          <a href="https://chrislabarge.com/tags/ruby/"
             class="active">
             ruby
            <span class="float-right">4</span>
          </a>
        </li>
      
        <li>
          <a href="https://chrislabarge.com/tags/linux/"
             class="">
             linux
            <span class="float-right">3</span>
          </a>
        </li>
      
        <li>
          <a href="https://chrislabarge.com/tags/ruby-on-rails/"
             class="active">
             ruby-on-rails
            <span class="float-right">3</span>
          </a>
        </li>
      
        <li>
          <a href="https://chrislabarge.com/tags/git/"
             class="">
             git
            <span class="float-right">1</span>
          </a>
        </li>
      
        <li>
          <a href="https://chrislabarge.com/tags/javascript/"
             class="">
             javascript
            <span class="float-right">1</span>
          </a>
        </li>
      
        <li>
          <a href="https://chrislabarge.com/tags/movies/"
             class="">
             movies
            <span class="float-right">1</span>
          </a>
        </li>
      
        <li>
          <a href="https://chrislabarge.com/tags/open-source/"
             class="">
             open-source
            <span class="float-right">1</span>
          </a>
        </li>
      
        <li>
          <a href="https://chrislabarge.com/tags/raspberry-pi/"
             class="">
             raspberry-pi
            <span class="float-right">1</span>
          </a>
        </li>
      
        <li>
          <a href="https://chrislabarge.com/tags/resource/"
             class="">
             resource
            <span class="float-right">1</span>
          </a>
        </li>
      
        <li>
          <a href="https://chrislabarge.com/tags/vim/"
             class="">
             vim
            <span class="float-right">1</span>
          </a>
        </li>
      
    </ul>
  
</nav>

<section class="blog-post">
    
    <img class="header-img" src="/img/trash.jpg" alt="A photo of an mesh office trash can, with some crumpled up papers inside." />
    
    <h1>How to use Rails the Active Record Relation method #delete_all</h1>
    <div class="blog-post-subheader">
        
            <span class="date-title">
                May 23, 2018
            </span>
        
        <a href="/posts/index.xml" class="tooltip">
            <span class="tooltip-text">RSS Feed</span>
            <i class="fas fa-rss"></i>
        </a>
        
        
          <span id="onlyFiles">
            <a href="#files" class="tooltip" id="quickView">
              <span class="tooltip-text">Only Files</span>
              Quick View
            </a>
            <a href="https://chrislabarge.com/posts/delete-all/" class="tooltip" style="display: none" id="normalView" >
              <span class="tooltip-text">Entire Post</span>
              Normal View
            </a>
          </span>
        
    </div>
    <div class="blog-post-content">
        <h2 id="what-you-will-learn">What You Will Learn</h2>
<ul>
<li>How to use <a href="https://apidock.com/rails/v6.0.0/ActiveRecord/Relation/delete_all"> ActiveRecord::Relation#delete_all </a> - A fast way to delete a large batch of rows from a Database table</li>
<li>How to use <a href="http://api.rubyonrails.org/classes/ActiveRecord/Batches.html#method-i-in_batches"> ActiveRecord::Batches::BatchEnumerator#in_batches </a> - To prevent from locking your Database</li>
</ul>
<h2 id="who-this-is-for">Who This Is For</h2>
<ul>
<li>Ruby on Rails developers who need to delete records more efficiently.</li>
</ul>
<h2 id="requirements">Requirements</h2>
<ul>
<li><a href="https://github.com/rails/rails">Ruby on Rails</a> &gt;= 5.0</li>
<li>Relational Database like <a href="https://www.mysql.com/">MySQL</a> or <a href="https://www.postgresql.org/">PostgreSQL</a></li>
</ul>
<h2 id="overview">Overview</h2>
<p>I am currently working on a Rails project that deals with importing and
exporting large amounts of data from excel sheets.  The user is able to import
and save the data into the application&rsquo;s Database and also delete the data.</p>
<p>Because some of these deletions can consist of hundreds of thousands of rows, the
removal feature must be developed a little differently.</p>
<h2 id="setup">Setup</h2>
<p>When a User imports/uploads new data into the application, a<code>DataUpload</code> record
is created, along with a new <code>DataSet</code> record, for every single row from the
imported exec sheet.</p>
<p>The model <code>DataSet</code> has a <code>belongs_to</code> relationship to <code>DataUpload</code>.</p>
<h4 class="snippet-heading" id="appmodelsdata_setrb-">app/models/data_set.rb</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-ruby" data-lang="ruby"><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">DataSet</span> <span style="color:#ff79c6">&lt;</span> ApplicationRecord
  belongs_to <span style="color:#f1fa8c">:data_uploads</span>
<span style="color:#ff79c6">end</span></code></pre></div>
<p>The model <code>DataUpload</code> has a <code>has_many</code> relationship to <code>DataSet</code>.</p>
<h4 class="snippet-heading" id="appmodelsdata_uploadrb-">app/models/data_upload.rb</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-ruby" data-lang="ruby"><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">DataUpload</span> <span style="color:#ff79c6">&lt;</span> ApplicationRecord
  has_many <span style="color:#f1fa8c">:data_sets</span>, <span style="color:#f1fa8c">dependent</span>: <span style="color:#f1fa8c">:destroy</span>
<span style="color:#ff79c6">end</span></code></pre></div>
<p>Notice the <code>dependent: :destroy</code>.  This means that when a <code>DataUpload</code> record
gets deleted/destroyed, all of the associated <code>DataSet</code> records will be
destroyed as well.</p>
<p>This also loads every associated <code>DataSet</code> model instance into memory as well.
This will bog down the server if there is a very large association of thousands
of <code>DataSet</code> records.</p>
<p>The way we solve this is to use the <code>ActiveRecord::Relation#delete_all</code>. This
<a href="https://apidock.com/rails/ActiveRecord/Relation/delete_all">method</a> performs a
single SQL statement and efficiently deletes all of the records within the
Relation.</p>
<p><em>Look at the example below.</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-ruby" data-lang="ruby">upload <span style="color:#ff79c6">=</span> DataUpload<span style="color:#ff79c6">.</span>last
data_sets <span style="color:#ff79c6">=</span> upload<span style="color:#ff79c6">.</span>data_sets

data_sets<span style="color:#ff79c6">.</span>delete_all</code></pre></div>
<blockquote>
<blockquote>
<h3 id="warning">WARNING</h3>
<ul>
<li><strong>DO NOT</strong> use this method on more then 5,000 records in a Database table.  It will lock the Database for the entire transaction.</li>
<li><code>#delete_all</code> does not load the record, so any callbacks will not be fired.  Make sure the application and/or model is not dependent on any pre/post delete processes.</li>
</ul>
</blockquote>
</blockquote>
<p>Now we can implement the method in the in the <code>DataUpload</code> callback.</p>
<h4 class="snippet-heading" id="appmodelsdata_uploadrb--1">app/models/data_upload.rb</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-ruby" data-lang="ruby"><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">DataUpload</span> <span style="color:#ff79c6">&lt;</span> ApplicationRecord
  has_many <span style="color:#f1fa8c">:data_sets</span>, <span style="color:#f1fa8c">dependent</span>: <span style="color:#f1fa8c">:delete_all</span>
<span style="color:#ff79c6">end</span></code></pre></div>
<p><strong>BUT WAIT!!</strong> If you were a good reader and saw the first WARNING above you
will notice that if I left the code this way and a particular <code>DataUpload</code>
instance had an association of more then 5,000 <code>DataSet</code> records&hellip; the
Database will lock for the entire transaction. To prevent from this we must
utilize one of the Ruby on Rails 5.0
<a href="http://api.rubyonrails.org/classes/ActiveRecord/Batches.html#method-i-in_batches">methods</a>
<code>#in_batches</code></p>
<p><em>If you are not use a Rails version that is &gt;= 5.0 then check out the gem <a href="https://github.com/ankane/delete_in_batches">delete_in_batches</a></em></p>
<h4 class="snippet-heading" id="appmodelsdata_uploadrb--2">app/models/data_upload.rb</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-ruby" data-lang="ruby"><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">DataUpload</span> <span style="color:#ff79c6">&lt;</span> ApplicationRecord
  has_many <span style="color:#f1fa8c">:data_sets</span>

  before_destroy <span style="color:#f1fa8c">:destroy_data_sets</span>

  <span style="color:#ff79c6">private</span>

  <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">destroy_data_sets</span>
    data_sets<span style="color:#ff79c6">.</span>in_batches(<span style="color:#f1fa8c">of</span>: <span style="color:#bd93f9">1000</span>)<span style="color:#ff79c6">.</span>delete_all
  <span style="color:#ff79c6">end</span>
<span style="color:#ff79c6">end</span></code></pre></div>
<p>First we remove the previous callback <code>dependent: :delete_all</code>, and replace it
with <code>before_destroy</code> callback and pass in the new private method
<code>#destroy_data_sets</code>.</p>
<p>You will notice that <code>#in_batches</code> takes an option <code>:of</code> set to <code>1000</code>. This
will limit the amount of records deleted in a single SQL transaction to 1,000.
Thus preventing the Database from locking.</p>

    </div>
</section>

        </div>
        <div class="footer" id="footer">
            <div class="contact-options">
                <div class="social-icons">
                    <a href="https://github.com/chrislabarge" class="tooltip">
                        <span class="tooltip-text">Github</span>
                        <i class="fab fa-github"></i>
                    </a>
                    <a href="https://gitlab.com/chrislabarge" class="tooltip">
                        <span class="tooltip-text">Gitlab</span>
                        <i class="fab fa-gitlab"></i>
                    </a>
                    <a href="https://twitter.com/clabvessels" class="tooltip">
                        <span class="tooltip-text">Twitter</span>
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="mailto:chrislabargedev@gmail.com" class="tooltip">
                        <span class="tooltip-text">Send Email</span>
                        <i class="far fa-envelope"></i>
                    </a>
                    <a id="light" class="toggle-theme tooltip">
                        <span class="tooltip-text"> Light Theme</span>
                        <i class="fas fa-sun"></i>
                    </a>
                    <a id="dark" class="toggle-theme tooltip" style="display: none">
                        <span class="tooltip-text">Dark Theme</span>
                        <i class="fas fa-moon"></i>
                    </a>
                </div>
            </div>

            
                <section id=nav>
                    <ul class=navbar>
                        <li><div><a href="/">Home</a></div></li>
                        <li><div><a href="/about">About Me</a></div></li>
                        <li><div><a href="/posts">Blog Posts</a></div></li>
                        <li><div><a href="/projects">Projects</a></div></li>
                    </ul>
                </section>
            
        </div>
    </body>
</html>

