<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">

        <title>Rails &#39;#delete_all&#39; - Fast &amp; Powerful - Beware</title>

        <link rel="stylesheet" href="/css/stylesheet.css">
        <link rel="stylesheet" href="/css/custom.css">
        <link rel="icon" type="image/png" href="/img/favicon.ico">

        <script src="/javascript/custom.js"></script>
        <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
    </head>
    <body>
        <section id="page-title">
            <h1><a href="/">Chris LaBarge</a></h1>
        </section>
        <div class="content">


<section class="blog-post">
    
    <img class="header-img" src="/img/trash.jpg" />
    
    <h1>Rails &#39;#delete_all&#39; - Fast &amp; Powerful - Beware</h1>
    <div class="blog-post-subheader">
        
            <span class="date-title">
                May 23, 2018
            </span>
        
        
    </div>
    <div class="blog-post-content">
        <h2 id="what-you-will-learn">What You Will Learn</h2>
<ul>
<li>A fast way to delete a large batch of rows from a Database table</li>
<li>How to prevent from locking your Database</li>
</ul>
<h2 id="who-this-is-for">Who This Is For</h2>
<ul>
<li>Rails developers who need to delete records more efficiently.</li>
</ul>
<h2 id="requirements">Requirements</h2>
<ul>
<li>Ruby</li>
<li>Rails &gt;= 5.0</li>
<li>Relational Database like MySQL or PostgreSQL</li>
</ul>
<h2 id="overview">Overview</h2>
<p>I am currently working on a Rails project that deals with importing and exporting large amounts of data.  The user is able to import and store data into the applications Database as well and delete the data.</p>
<p>Because some of these data deletions can consist of thousands of rows you must code the removal process a little differently.</p>
<p>When a User imports/uploads new data into the application it creates a new <code>DataUplodad</code> model.  The application also creates a new <code>DataSet</code> record for every single data set from the import.</p>
<p>I have the model <code>DataSet</code> which has a <code>belongs_to</code> relationship to <code>DataUploads</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-ruby" data-lang="ruby">  <span style="color:#ff79c6">class</span> <span style="color:#50fa7b">DataSet</span> <span style="color:#ff79c6">&lt;</span> ApplicationRecord
    belongs_to <span style="color:#f1fa8c">:data_uploads</span>
  <span style="color:#ff79c6">end</span></code></pre></div>
<p>I have the model <code>DataUploads</code> which has a <code>has_many</code> relationship to <code>DataSets</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-ruby" data-lang="ruby">  <span style="color:#ff79c6">class</span> <span style="color:#50fa7b">DataUpload</span> <span style="color:#ff79c6">&lt;</span> ApplicationRecord
    has_many <span style="color:#f1fa8c">:data_sets</span>, <span style="color:#f1fa8c">dependent</span>: <span style="color:#f1fa8c">:destroy</span>
  <span style="color:#ff79c6">end</span></code></pre></div>
<p>Notice the <code>dependent: :destroy</code>.  This means that when a <code>DataUpload</code> model gets deleted/destroyed, all of the associated <code>DataSet</code> models will all get destroyed as well.</p>
<p>This also loads every associated <code>DataSet</code> model into memory as well.  This will bog down the server if there is a very large association of thousands of <code>DataSet</code> records.</p>
<p>The way we solve this is to use the <code>ActiveRecord::Relation#delete_all</code>. This <a href="https://apidock.com/rails/ActiveRecord/Relation/delete_all">method</a> performs a single SQL statement and efficiently deletes all of the records within the Relation.</p>
<p><em>Look at the example below.</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-ruby" data-lang="ruby">  <span style="color:#6272a4"># Remove the data sets of the last Data Upload instance</span>
  upload <span style="color:#ff79c6">=</span> DataUpload<span style="color:#ff79c6">.</span>last
  data_sets <span style="color:#ff79c6">=</span> upload<span style="color:#ff79c6">.</span>data_sets

  data_sets<span style="color:#ff79c6">.</span>delete_all</code></pre></div>
<h3 id="warning">WARNING</h3>
<ul>
<li>DO NOT use this method on more then 5,000 records in a Database table.  It will lock the Database for the entire transaction.</li>
<li><code>#delete_all</code> does not load the record, so any callbacks will not be fired.  Make sure the application and/or model is not dependent on any pre/post delete processes.</li>
</ul>
<p>Now we can implement the method in the in the <code>DataUpload</code> callback.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-ruby" data-lang="ruby">  <span style="color:#ff79c6">class</span> <span style="color:#50fa7b">DataUpload</span> <span style="color:#ff79c6">&lt;</span> ApplicationRecord
    has_many <span style="color:#f1fa8c">:data_sets</span>, <span style="color:#f1fa8c">dependent</span>: <span style="color:#f1fa8c">:delete_all</span>
  <span style="color:#ff79c6">end</span></code></pre></div>
<p>BUT WAIT!! If you were a good reader and saw the first WARNING above you will notice that if I left the code this way and a particular <code>DataUpload</code> instance had an association of more then 5,000 <code>DataSet</code> records&hellip;the Database will lock for the entire transaction. To prevent from this we must utilize one of the Ruby on Rails 5.0 <a href="http://api.rubyonrails.org/classes/ActiveRecord/Batches.html#method-i-in_batches">methods</a> <code>#in_batches</code></p>
<p><em>If you are not use a Rails version that is &gt;= 5.0 then check out the gem <a href="https://github.com/ankane/delete_in_batches">delete_in_batches</a></em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-ruby" data-lang="ruby">  <span style="color:#ff79c6">class</span> <span style="color:#50fa7b">DataUpload</span> <span style="color:#ff79c6">&lt;</span> ApplicationRecord
    has_many <span style="color:#f1fa8c">:data_sets</span>

    before_destroy <span style="color:#f1fa8c">:destroy_data_sets</span>

    <span style="color:#ff79c6">private</span>

    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">destroy_data_sets</span>
      data_sets<span style="color:#ff79c6">.</span>in_batches(<span style="color:#f1fa8c">of</span>: <span style="color:#bd93f9">1000</span>)<span style="color:#ff79c6">.</span>delete_all
    <span style="color:#ff79c6">end</span>
  <span style="color:#ff79c6">end</span></code></pre></div>
<p>First we remove the previous callback <code>dependent: :delete_all</code>, and replace it with <code>before_destroy</code> callback and pass in the new private method <code>#destroy_data_sets</code>.</p>
<p>You will notice that <code>#in_batches</code> takes an option <code>:of</code> set to <code>1000</code>. This will limit the amount of records deleted in a single SQL transaction to 1,000.  Thus preventing the Database from locking.</p>

    </div>
</section>

        </div>
        <div class="footer" id="footer">
            <div class="contact-options">
                <div class="social-icons">
                    <a href="https://github.com/chrislabarge" class="tooltip">
                        <span class="tooltip-text">Github</span>
                        <i class="fab fa-github"></i>
                    </a>
                    <a href="https://gitlab.com/chrislabarge" class="tooltip">
                        <span class="tooltip-text">Gitlab</span>
                        <i class="fab fa-gitlab"></i>
                    </a>
                    <a href="mailto:chrislabargedev@gmail.com" class="tooltip">
                        <span class="tooltip-text">Send Email</span>
                        <i class="far fa-envelope"></i>
                    </a>
                    <a id="light" class="toggle-theme tooltip">
                        <span class="tooltip-text"> Light Theme</span>
                        <i class="fas fa-sun"></i>
                    </a>
                    <a id="dark" class="toggle-theme tooltip" style="display: none">
                        <span class="tooltip-text">Dark Theme</span>
                        <i class="fas fa-moon"></i>
                    </a>
                </div>
            </div>

            
                <section id=nav>
                    <ul class=navbar>
                        <li><div><a href="/">Home</a></div></li>
                        <li><div><a href="/about">About Me</a></div></li>
                        <li><div><a href="/projects">Projects</a></div></li>
                        <li><div><a href="/posts">Blog</a></div></li>
                    </ul>
                </section>
            
        </div>
    </body>
</html>

